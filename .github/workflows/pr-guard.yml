name: Zentosys AI PR Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write # needed for optional PR comments
  actions: read

jobs:
  ai-pr-guard:
    name: AI Security & Quality Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ---------------------------------------
      # 1️⃣ Checkout full git history (needed for diff)
      # ---------------------------------------
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------
      # 2️⃣ Set up Docker (Buildx)
      # ---------------------------------------
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # ---------------------------------------
      # 3️⃣ Build PR Guard Docker Image
      # ---------------------------------------
      - name: Build PR Guard Image
        run: |
          docker build \
            --no-cache \
            -t zentosys-ai-pr-guard .

      # ---------------------------------------
      # 4️⃣ Run Zentosys AI PR Guard
      # ---------------------------------------
      - name: Run AI PR Guard
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker run --rm \
            -e OPENAI_API_KEY \
            -v ${{ github.workspace }}/reports:/app/reports \
            zentosys-ai-pr-guard

      # ---------------------------------------
      # 5️⃣ Upload Final Report (CI Artifact)
      # ---------------------------------------
      - name: Upload PR Guard Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zentosys-ai-pr-guard-report
          path: reports/

      # ---------------------------------------
      # 6️⃣ (Optional) Post PR Summary Comment
      # ---------------------------------------
      # Uncomment when ready
      #
      # - name: Comment PR with AI Summary
      #   if: always()
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const fs = require('fs');
      #       const summary = fs.readFileSync(
      #         'reports/final-report.md',
      #         'utf8'
      #       );
      #
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: summary
      #       });
